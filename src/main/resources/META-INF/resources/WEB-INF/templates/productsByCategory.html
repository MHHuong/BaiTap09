<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Products by Category</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Lọc sản phẩm theo Category</h3>
    <div>
        <a href="/products" class="btn btn-outline-secondary me-2">Tất cả sản phẩm</a>
        <a href="/admin/home" class="btn btn-outline-primary me-2">Admin</a>
        <a href="/logout" class="btn btn-outline-danger">Đăng xuất</a>
    </div>
</div>

<div id="error" class="alert alert-danger d-none"></div>

<div class="row g-3 mb-3">
    <div class="col-md-6">
        <label class="form-label">Category</label>
        <select id="catSel" class="form-select" onchange="loadProductsByCat()">
            <option value="">-- chọn category --</option>
        </select>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped align-middle" id="prodTable">
        <thead>
        <tr>
            <th style="width:80px">ID</th>
            <th>Title</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Owner</th>
        </tr>
        </thead>
        <tbody><!-- filled --></tbody>
    </table>
</div>

<script>
    const endpoint = '/graphql';

    async function gql(query, variables) {
        hideError();
        const r = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({query, variables})
        });
        const json = await r.json();
        if (json.errors && json.errors.length) {
            showError(json.errors[0].message);
            throw new Error(json.errors[0].message);
        }
        return json.data;
    }

    function showError(m) {
        const el = document.getElementById('error');
        el.textContent = m;
        el.classList.remove('d-none');
    }

    function hideError() {
        document.getElementById('error').classList.add('d-none');
    }

    async function loadCategories() {
        const {categories} = await gql(`query{ categories{ id name } }`);
        const sel = document.getElementById('catSel');
        sel.innerHTML = `<option value="">-- chọn category --</option>`;
        categories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.name} (#${c.id})`;
            sel.appendChild(opt);
        });
    }

    async function loadProductsByCat() {
        const sel = document.getElementById('catSel');
        const categoryId = sel.value;
        const tbody = document.querySelector('#prodTable tbody');
        tbody.innerHTML = '';
        if (!categoryId) return;

        const query = `
    query($categoryId:ID!){
      productsByCategory(categoryId:$categoryId){
        id title quantity price user{ id fullname }
      }
    }
  `;
        const {productsByCategory} = await gql(query, {categoryId: Number(categoryId)});
        productsByCategory.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.title}</td>
      <td>${p.quantity ?? ''}</td>
      <td>${p.price ?? ''}</td>
      <td>${p.user ? (p.user.fullname + ' (#' + p.user.id + ')') : ''}</td>`;
            tbody.appendChild(tr);
        });
    }

    (async function () {
        try {
            await loadCategories();
        } catch (e) {
            console.error(e);
        }
    })();
</script>
</body>
</html>