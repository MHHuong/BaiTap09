<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Products by Category</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
</head>
<body class="container py-4">
<h3>Products by Category</h3>

<select id="category" class="form-select w-auto"></select>
<table class="table mt-3" id="tbl">
    <thead><tr><th>Title</th><th>Price</th><th>Owner</th></tr></thead>
    <tbody></tbody>
</table>

<script>
    const endpoint = '/graphql';

    async function gql(query, variables){
        const r = await fetch(endpoint, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ query, variables })
        });
        return (await r.json()).data;
    }

    async function loadCategories(){
        const data = await gql(`query{ categories{ id name } }`);
        const sel = document.getElementById('category');
        const cats = (data && data.categories) ? data.categories : [];
        sel.innerHTML = cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        sel.onchange = loadProducts;
        if (sel.value) loadProducts();
    }

    async function loadProducts(){
        const id = document.getElementById('category').value;
        const data = await gql(
            `query($cid: ID!){ productsByCategory(categoryId:$cid){ title price user{fullname} } }`,
            { cid: id }
        );
        const rows = (data && data.productsByCategory) ? data.productsByCategory : [];
        document.querySelector('#tbl tbody').innerHTML =
            rows.map(p=>`<tr><td>${p.title??''}</td><td>${p.price??''}</td><td>${p.user?.fullname??''}</td></tr>`).join('');
    }

    loadCategories();
</script>
</body>
</html>