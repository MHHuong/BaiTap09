<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Home</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table td, .table th { vertical-align: middle; }
        .error-box { white-space: pre-wrap; }
    </style>
</head>
<body class="container py-4">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Admin – Quản lý Category & Product</h3>
    <div>
        <a href="/products" class="btn btn-outline-secondary me-2">Xem Products</a>
        <a href="/logout" class="btn btn-outline-danger">Đăng xuất</a>
    </div>
</div>

<!-- Error area -->
<div id="error" class="alert alert-danger d-none error-box"></div>
<div id="info"  class="alert alert-success d-none"></div>

<div class="row g-4">
    <!-- ===== CATEGORY ===== -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header fw-bold">Category</div>
            <div class="card-body">
                <form id="catForm" class="row g-2" onsubmit="return submitCategory(event)">
                    <div class="col-12">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input id="catName" class="form-control" required maxlength="100" placeholder="VD: Laptop">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Images (URL)</label>
                        <input id="catImages" class="form-control" placeholder="https://...">
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary">Tạo Category</button>
                    </div>
                </form>

                <hr>

                <h6 class="mt-2">Danh sách Category</h6>
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="catTable">
                        <thead>
                        <tr>
                            <th style="width:80px">ID</th>
                            <th>Name</th>
                            <th>Images</th>
                            <th style="width:120px">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody><!-- filled by JS --></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== PRODUCT ===== -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header fw-bold">Product</div>
            <div class="card-body">
                <form id="prodForm" class="row g-2" onsubmit="return submitProduct(event)">
                    <div class="col-12">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input id="prodTitle" class="form-control" required placeholder="VD: MacBook Air M2">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Quantity</label>
                        <input id="prodQty" type="number" min="0" step="1" class="form-control" placeholder="0">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Price</label>
                        <input id="prodPrice" type="number" min="0" step="0.01" class="form-control" placeholder="0">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea id="prodDesc" class="form-control" rows="2" placeholder="Mô tả ngắn..."></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Owner (User)</label>
                        <select id="prodUser" class="form-select"></select>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary">Tạo Product</button>
                    </div>
                </form>

                <hr>

                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mt-2 m-0">Danh sách Product</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadProducts()">Tải lại</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadProductsByPriceAsc()">Giá ↑</button>
                    </div>
                </div>

                <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="prodTable">
                        <thead>
                        <tr>
                            <th style="width:80px">ID</th>
                            <th>Title</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Owner</th>
                            <th style="width:120px">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody><!-- filled by JS --></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const endpoint = '/graphql';

    // GQL helper + error display
    async function gql(query, variables){
        hideMsg();
        const r = await fetch(endpoint, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ query, variables })
        });
        const json = await r.json();
        if (json.errors && json.errors.length){
            showError(json.errors[0].message);
            throw new Error(json.errors[0].message);
        }
        return json.data;
    }

    function showError(msg){
        const el = document.getElementById('error');
        el.textContent = msg;
        el.classList.remove('d-none');
    }
    function showInfo(msg){
        const el = document.getElementById('info');
        el.textContent = msg;
        el.classList.remove('d-none');
    }
    function hideMsg(){
        document.getElementById('error').classList.add('d-none');
        document.getElementById('info').classList.add('d-none');
    }

    /* ================= CATEGORY ================= */
    async function submitCategory(e){
        e.preventDefault();
        const name = document.getElementById('catName').value.trim();
        const images = document.getElementById('catImages').value.trim();

        const query = `
    mutation ($in: CategoryInput!){
      createCategory(in:$in){ id name images }
    }
  `;
        const variables = { in: { name, images: images || null } };
        const data = await gql(query, variables);
        showInfo('Đã tạo category: ' + data.createCategory.name);
        document.getElementById('catForm').reset();
        loadCategories();
    }

    async function loadCategories(){
        const { categories } = await gql(`query{ categories{ id name images } }`);
        const tbody = document.querySelector('#catTable tbody');
        tbody.innerHTML = '';
        categories.forEach(c=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.images ? `<a href="${c.images}" target="_blank">link</a>` : ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${c.id})">Xóa</button>
      </td>`;
            tbody.appendChild(tr);
        });
        // cập nhật dropdown lọc theo category ở trang khác nếu muốn
    }

    async function deleteCategory(id){
        if(!confirm('Xóa category #' + id + ' ?')) return;
        const data = await gql(`mutation($id:ID!){ deleteCategory(id:$id) }`, { id });
        if (data.deleteCategory){
            showInfo('Đã xóa category #' + id);
            loadCategories();
        }
    }

    /* ================= PRODUCT ================= */
    async function submitProduct(e){
        e.preventDefault();
        const title = document.getElementById('prodTitle').value.trim();
        const quantity = document.getElementById('prodQty').value ? parseInt(document.getElementById('prodQty').value) : null;
        const price = document.getElementById('prodPrice').value ? parseFloat(document.getElementById('prodPrice').value) : null;
        const description = document.getElementById('prodDesc').value.trim() || null;
        const userId = document.getElementById('prodUser').value || null;

        const query = `
    mutation ($in: ProductInput!){
      createProduct(in:$in){ id title }
    }
  `;
        const variables = { in: { title, quantity, price, description, userId: userId? Number(userId): null } };
        const data = await gql(query, variables);
        showInfo('Đã tạo product: ' + data.createProduct.title);
        document.getElementById('prodForm').reset();
        loadProducts();
    }

    async function loadProducts(){
        const { products } = await gql(`query{ products{ id title quantity price user{ id fullname } } }`);
        renderProducts(products);
    }

    async function loadProductsByPriceAsc(){
        const { productsByPriceAsc } = await gql(`query{ productsByPriceAsc{ id title quantity price user{ id fullname } } }`);
        renderProducts(productsByPriceAsc);
    }

    function renderProducts(list){
        const tbody = document.querySelector('#prodTable tbody');
        tbody.innerHTML = '';
        list.forEach(p=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.title}</td>
      <td>${p.quantity ?? ''}</td>
      <td>${p.price ?? ''}</td>
      <td>${p.user ? (p.user.fullname + ' (#' + p.user.id + ')') : ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})">Xóa</button>
      </td>`;
            tbody.appendChild(tr);
        });
    }

    async function deleteProduct(id){
        if(!confirm('Xóa product #' + id + ' ?')) return;
        const data = await gql(`mutation($id:ID!){ deleteProduct(id:$id) }`, { id });
        if (data.deleteProduct){
            showInfo('Đã xóa product #' + id);
            loadProducts();
        }
    }

    /* ================= USERS for owner select ================= */
    async function loadUsersForOwner(){
        const { users } = await gql(`query{ users{ id fullname } }`);
        const sel = document.getElementById('prodUser');
        sel.innerHTML = `<option value="">-- Không chọn --</option>`;
        users.forEach(u=>{
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = `${u.fullname} (#${u.id})`;
            sel.appendChild(opt);
        });
    }

    /* ================= BOOT ================= */
    (async function boot(){
        try{
            await Promise.all([loadCategories(), loadUsersForOwner(), loadProducts()]);
        }catch(e){
            console.error(e);
        }
    })();
</script>
</body>
</html>