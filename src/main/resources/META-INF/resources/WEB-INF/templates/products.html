<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Products</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Products</h3>
    <div>
        <a href="/admin/home" class="btn btn-outline-secondary me-2">Admin</a>
        <a href="/products-by-category" class="btn btn-outline-primary me-2">Lọc theo Category</a>
        <a href="/logout" class="btn btn-outline-danger">Đăng xuất</a>
    </div>
</div>

<div id="error" class="alert alert-danger d-none"></div>

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-sm btn-outline-secondary" onclick="loadAll()">Tất cả</button>
    <button class="btn btn-sm btn-outline-primary" onclick="loadByPriceAsc()">Giá ↑</button>
</div>

<div class="table-responsive">
    <table class="table table-striped align-middle" id="prodTable">
        <thead>
        <tr>
            <th style="width:80px">ID</th>
            <th>Title</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Owner</th>
        </tr>
        </thead>
        <tbody><!-- filled --></tbody>
    </table>
</div>

<script>
    const endpoint = '/graphql';

    async function gql(query, variables) {
        hideError();
        const r = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({query, variables})
        });
        const json = await r.json();
        if (json.errors && json.errors.length) {
            showError(json.errors[0].message);
            throw new Error(json.errors[0].message);
        }
        return json.data;
    }

    function showError(m) {
        const el = document.getElementById('error');
        el.textContent = m;
        el.classList.remove('d-none');
    }

    function hideError() {
        document.getElementById('error').classList.add('d-none');
    }

    function render(list) {
        const tb = document.querySelector('#prodTable tbody');
        tb.innerHTML = '';
        list.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.title}</td>
      <td>${p.quantity ?? ''}</td>
      <td>${p.price ?? ''}</td>
      <td>${p.user ? (p.user.fullname + ' (#' + p.user.id + ')') : ''}</td>`;
            tb.appendChild(tr);
        });
    }

    async function loadAll() {
        const {products} = await gql(`query{ products{ id title quantity price user{ id fullname } } }`);
        render(products);
    }

    async function loadByPriceAsc() {
        const {productsByPriceAsc} = await gql(`query{ productsByPriceAsc{ id title quantity price user{ id fullname } } }`);
        render(productsByPriceAsc);
    }

    (async function () {
        try {
            await loadAll();
        } catch (e) {
            console.error(e);
        }
    })();
</script>
</body>
</html>